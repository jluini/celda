# Main script

main:
	init:
		
		.set key1_was_taken=false
		.set cobble_already_fell=false
		.set jaula_esta_abierta=false
		.set oficina_fue_descubierta=false
		
		jaula_a_oficina.disable
		adoquin.disable
		
		if $stage < 2:
			.load_room jaula at=posicion/inicial
			.set music=celda
			.curtain_up
			
			if $stage = 0:
				
				# ... intro goes here
				.say INTRO
				
			else:
				
				inv_libro.add
				inv_calavera.add
				inv_llave2.add
				inv_frasco.add
				inv_llave1.add
		else:
			
			poster.disable
			jaula_a_oficina.enable
			jaula_a_oficina.play open
			inv_poster.add
			
			palo.disable
			inv_palo.add
			
			# etapa oficina
			if $stage = 2:
				.load_room office at=posicion/de_jaula
				.set music=office
				.curtain_up
			
			# living stage
			elif $stage = 3:
				.load_room living at=positions/from_office
				.set music=office
				.curtain_up
			
			else:
				.set key1_was_taken=true
				inv_llave1.add
				living/small_box.play open
				
				# TODO otras modificaciones
				
				# etapa jaula abierta
				if $stage = 4:
					.load_room jaula_abierta at=posicion/de_oficina
					.set music=uajari
					.curtain_up
				
				# cellar stage
				elif $stage = 5:
					.load_room cellar at=positions/from_cage
					.set music=lab
					.curtain_up
				
				# lab stage
				elif $stage = 6:
					.load_room lab at=positions/from_cellar
					.set music=lab
					.curtain_up
				
				# ...

# Inventory items

inv_poster:
	look:
		you.say LOOK_POSTER
	
	use:
		self.set_tool use_with

inv_libro:
	look:
		you.say LOOK_BOOK
	use:
		self.set_tool use_with

inv_palo:
	look:
		you.say LOOK_INV_STICK
	use:
		self.set_tool use_with

inv_calavera:
	look:
		you.say LOOK_SKULL
	use:
		self.set_tool use_with

inv_llave1:
	look:
		you.say LOOK_KEY1
	use:
		self.set_tool use_with

inv_llave2:
	look:
		you.say LOOK_KEY2
	use:
		self.set_tool use_with

inv_frasco:
	look:
		you.say LOOK_FLASK
	use:
		self.set_tool use_with

# Items jaula

inodoro:
	look:
		you.say LOOK_TOILET
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say BAD_IDEA
	
	use_with(inv_llave*):
		you.say USE_KEY_WITH_TOILET1
		you.say USE_KEY_WITH_TOILET2
	
	use_with(inv_frasco):
		you.say USE_FLASK_WITH_TOILET
	
	use_with(inv_poster):
		you.say USE_POSTER_WITH_TOILET
	
	use_with(*):
		you.say USE_X_WITH_TOILET

cama:
	look:
		you.say LOOK_BED
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say SAY_NO
	
	use_with(inv_llave*):
		you.say USE_KEY_WITH_BED
	
	use_with(inv_frasco):
		you.say FOR_WHAT
	
	use_with(*): TK
		you.say INVALID_COMBINATION
	

poster:
	look:
		you.say LOOK_POSTER
	
	hand:
		self.disable
		inv_poster.add
		
		if $cobble_already_fell:
			jaula_a_oficina.enable
			jaula_a_oficina.play opening blocking=true
			jaula_a_oficina.play open
		else:
			adoquin.enable
		
	# TODO use_with(inv_palo): "No le haría daño" ?
	
	use_with(*):
		you.say INVALID_COMBINATION

adoquin:
	look:
		you.say LOOK_COBBLE
	
	hand:
		you.say "TODO"
	
	use_with(inv_poster):
		self.disable
		tool.remove
		poster.enable
	
	use_with(inv_palo):
		you.say USE_STICK_WITH_COBBLE
		self.disable
		.set cobble_already_fell=true
		
		jaula_a_oficina.enable
		jaula_a_oficina.play opening blocking=true
		jaula_a_oficina.play open

jaula_a_oficina:
	walk_to:
		.load_room office at=posicion/de_jaula
		
		if not $oficina_fue_descubierta:
			.set oficina_fue_descubierta=true
			.set music=office
			#.curtain_up
			you.say "Mirá vo el cacho de oficina" # TODO
	
	use_with(inv_poster):
		self.play closing blocking=true
		self.play default
		self.disable
		poster.enable
		tool.remove

palo:
	look:
		you.say LOOK_CAGE_STICK
	
	hand:
		self.disable
		inv_palo.add

reja:
	look:
		you.say LOOK_BARS
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say "TODO ruido metal contra metal"
	
	use_with(inv_llave1):
		if not $jaula_esta_abierta:
			.set music=""
			you.say USE_KEY_WITH_BARS
			.set music="uajari"
			.set jaula_esta_abierta=true
			.load_room jaula_abierta at=posicion/abriendo_reja
		else:
			you.say USE_KEY_WITH_BARS_AGAIN
		
	use_with(inv_llave*):
		you.say WRONG_KEY
	
	use_with(inv_frasco):
		you.say NOT_A_GOOD_IDEA
	
	use_with(*):
		if not $jaula_esta_abierta:
			you.say CANT_OPEN_IT_WITH_THIS
		else:
			you.say FOR_WHAT

jaula_puerta:
	look:
		if not $jaula_esta_abierta:
			you.say CANT_REACH_DOOR
		else:
			you.say "TODO"
	
	hand:
		if not $jaula_esta_abierta:
			you.say CANT_REACH_DOOR
		else:
			you.say TRY_TO_OPEN_CAGE_DOOR
		
	use_with(inv_llave*):
		if not $jaula_esta_abierta:
			you.say CANT_REACH_DOOR
		else:
			you.say WRONG_KEY
	
	use_with(*):
		if not $jaula_esta_abierta:
			you.say CANT_REACH_DOOR
		else:
			you.say CANT_OPEN_IT_WITH_THIS

jaula_a_sotano:
	walk_to:
		.load_room cellar at=positions/from_cage
		# keep music 'uajari'
		#.curtain_up

# Items oficina

armadura:
	look:
		you.say LOOK_ARMOUR
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say "TODO ruido de palo contra metal"
	
	use_with(inv_llave*):
		you.say DOES_NOT_HAVE_A_LOCK
	
	use_with(*):
		you.say INVALID_COMBINATION

busto:
	look:
		you.say LOOK_BUST
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say I_CANT_DO_ANYTHING
	
	use_with(inv_frasco):
		you.say IT_WOULDNT_BE_WISE
	
	use_with(inv_llave*):
		you.say DOES_NOT_HAVE_A_LOCK
	
	use_with(*):
		you.say INVALID_COMBINATION

escritorio_oficina:
	look:
		you.say LOOK_OFFICE_DESK
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say IT_IS_USELESS
	
	use_with(inv_llave*):
		you.say USE_KEY_WITH_OFFICE_DESK
	
	use_with(inv_frasco):
		you.say DOES_NOT_WORK
	
	use_with(*):
		you.say INVALID_COMBINATION

silla_oficina:
	look:
		you.say LOOK_OFFICE_CHAIR
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say IT_DOESNT_MAKE_SENSE
	
	use_with(inv_llave*):
		you.say CANT_BE_OPENED_WITH_KEY
	
	use_with(*):
		you.say INVALID_COMBINATION

oficina_a_jaula:
	walk_to:
		if not $jaula_esta_abierta:
			.load_room jaula at=posicion/de_oficina
			# keep music 'office'
			#.curtain_up
		else:
			.load_room jaula_abierta at=posicion/de_oficina
			# keep music 'office'
			#.curtain_up

oficina_a_living:
	walk_to:
		.load_room living at=positions/from_office
		# keep music 'office'
		#.curtain_up

# Living items

living/to_office:
	walk_to:
		.load_room office at=posicion/de_living
		# keep music 'office'
		#.curtain_up

living/furniture:
	look:
		you.say LOOK_FURNITURE
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say USE_STICK_WITH_FURNITURE
	
	use_with(inv_llave*):
		you.say IT_DOESNT_FIT
	
	use_with(*):
		you.say INVALID_COMBINATION

living/mirror:
	look:
		you.say LOOK_MIRROR
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say USE_STICK_WITH_MIRROR
	
	use_with(*):
		you.say INVALID_COMBINATION

living/bear:
	look:
		you.say LOOK_BEAR
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say USE_STICK_WITH_BEAR
	
	use_with(inv_llave*):
		you.say USE_KEY_WITH_BEAR
	
	use_with(inv_frasco):
		you.say DOES_NOT_WORK
	
	use_with(inv_calavera):
		you.say USE_SKULL_WITH_BEAR
	
	use_with(*):
		you.say INVALID_COMBINATION

living/window:
	look:
		you.say LOOK_LIVING_WINDOW
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say "TODO ruido de golpear madera"
	
	use_with(*):
		you.say INVALID_COMBINATION # TODO "No se abre así." ?

living/door:
	look:
		you.say LOOK_LIVING_DOOR1
		you.say LOOK_LIVING_DOOR2
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say IT_IS_USELESS
		# TODO ruido de palo contra madera
	
	use_with(inv_llave*):
		you.say USE_KEY_WITH_LIVING_DOOR
	
	use_with(inv_frasco):
		you.say NOTHING_HAPPENS
	
	use_with(*):
		you.say USE_X_WITH_LIVING_DOOR

living/strongbox:
	look:
		you.say LOOK_STRONGBOX
	
	hand:
		you.say "TODO"
	

living/small_box:
	look:
		you.say LOOK_SMALL_BOX1
	
	hand:
		if $inv_llave1 = 0:
			if not $key1_was_taken:
				you.say LOOK_SMALL_BOX2
			else:
				you.say LOOK_SMALL_BOX_AGAIN
			inv_llave1.add
			self.play open
			if not $key1_was_taken:
				you.say LOOK_SMALL_BOX3
				.set key1_was_taken=true
		else:
			you.say LOOK_SMALL_BOX_OPENED
	
	use_with(inv_llave1):
		you.say SAVE_KEY_IN_BOX
		tool.remove
		self.play default
	
	use_with(inv_llave*):
		you.say SAVE_ANOTHER_KEY_IN_BOX
	
	use_with(*):
		you.say SAVE_X_IN_BOX # OJO esto implica que cualquier objeto pequeño debe tener otra rutina

living/candelabrum:
	look:
		you.say LOOK_CANDELABRUM
	
	hand:
		you.say "TODO"

living/picture:
	look:
		#you.say LOOK_PICTURE
		.load_room picture
		#.curtain_up
	
	hand:
		.load_room picture

picture/to_living:
	walk_to:
		.load_room living at=living/picture
		#.curtain_up

# Cellar items

cellar/to_cage:
	walk_to:
		.load_room jaula_abierta at=posicion/de_sotano
		.set music=uajari
		#.curtain_up

cellar/to_lab:
	#hand:
	walk_to:
		.load_room lab at=positions/from_cellar
		.set music=lab
		#.curtain_up
	#look:
	#	.load_room lab_door
	#	#.curtain_up

cellar/bucket:
	look:
		you.say LOOK_BUCKET
	
	hand:
		you.say "TODO"
	
	use_with(*):
		you.say USE_X_WITH_BUCKET

cellar/pump:
	look:
		you.say LOOK_PUMP
	
	hand:
		you.say "TODO"
	
	use_with(inv_palo):
		you.say "*Ruido metálico*" # TODO
	
	use_with(inv_llave*):
		you.say USE_KEY_WITH_PUMP
	
	use_with(inv_frasco):
		you.say USE_FLASK_WITH_PUMP
	
	use_with(*):
		you.say INVALID_COMBINATION

cellar/doc:
	look:
		.wait 1
		.load_room doc
		.wait 1
		you.say "Es un tipo todo tirado."
		you.say "Pero qué laaaaco..."
		you.say "Casi que le entraría."
	hand:
		# TODO codigo duplicado
		.wait 1
		.load_room doc
		.wait 1
		you.say "Es un tipo todo tirado."
		you.say "Pero qué laaaaco..."
		you.say "Casi que le entraría."

doc/to_cellar:
	walk_to:
		.load_room cellar at=cellar/doc

# Lab items

lab_door/to_cellar:
	walk_to:
		.load_room cellar at=cellar/to_lab


lab/to_cellar:
	walk_to:
		.load_room cellar at=positions/from_lab
		# keep music 'lab'
		#.curtain_up

lab/guy:
	look:
		.load_room guy
	hand:
		.load_room guy

guy/to_lab:
	walk_to:
		.load_room lab at=lab/guy

lab/desk:
	look:
		.load_room desk
	hand:
		.load_room desk

desk/to_lab:
	walk_to:
		.load_room lab at=lab/desk
